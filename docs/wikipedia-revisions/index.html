<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Social Communication Temporal Graph - Wikipedia Revisions</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css'>
    <style>
        .node.node-focus .link line {
            stroke: black;
            stroke-opacity: 0.8;
            stroke-width: 0.8;
        }

        .node.node-focus circle {
            stroke: black;
            stroke-opacity: 1;
            stroke-width: 1;
            opacity: 1;
        }
    </style>
</head>

<body translate="no">
    <div class="container-fluid">

        <div class="form">
        </div>
        <div class="main">
            <div class="row">
                <div class="col-12">
                    <h1>Wikipedia Revision History for <span id="page-title">Narendra Modi</span>'s Wikipedia page</h1>
                    <p>Data taken from the wikipedia API to get the last 500 revisions to the page.</p>
                    <p>This visualization is based on <a href="https://github.com/napsternxg/social-comm-temporal-graph">Social Communication Temporal Graph</a></p>
                </div>
            </div>
            <form onSubmit="return false;">
                <div class="row">
                    <div class="col-7">
                        <label for="wiki-title-input" class="sr-only">Wikipedia Title</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="input-group-text">Wiki Title</div>
                            </div>
                            <input type="text" class="form-control" id="wiki-title-input" value="Narendra Modi" placeholder="Password">
                        </div>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-primary btn-md" id="plot-sctg">Plot</button>
                    </div>
                </div>
            </form>
            <div class="row">
                <div class="col-10">
                    <svg width="960" height="500"></svg>
                </div>
            </div>
            <div class="row">
                <div class="col-7">
                    <div class="log-data"></div>
                </div>
            </div>
        </div>
    </div>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.2/d3.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.js'></script>
    <script src='../sctg.js'></script>
    <script id="rendered-js">
        async function createPlot() {
            /**
             * To fetch data from wikipedia API, we need to add origin=* to the get parameter request
             **/
            const title_input = d3.select("#wiki-title-input").property("value");
            console.log(title_input);
            const URL = `https://en.wikipedia.org/w/api.php?action=query&prop=revisions&titles=${encodeURIComponent(
  title_input)
  }&rvlimit=500&rvprop=timestamp%7Cuser%7Csize%7Cparsedcomment%7Cids&format=json&origin=*`;
            //"https://gist.githubusercontent.com/napsternxg/762600d0c95a7e2c6252a57438cfdad1/raw/373a35a63ce8a6658d94c1fae6140f98f7eda31f/modi-revisions.json";
            console.log(URL);
            const data = await d3.json(URL);

            d3.select("#page-title").text(title_input);

            strictIsoParse = d3.utcParse("%Y-%m-%dT%H:%M:%SZ");

            const page_id = Object.keys(data["query"]["pages"])[0];
            //console.log(data);
            const parsed_json = data["query"]["pages"][page_id];
            const title = parsed_json["title"];

            d3.select("page-title").text(title);
            const revisions = parsed_json["revisions"];

            const parsed_data = revisions.map(d => {
                return {
                    id: d["revid"],
                    user: d["user"],
                    size: +d["size"],
                    timestamp: strictIsoParse(d["timestamp"]),
                    parsedcomment: d["parsedcomment"]
                };

            });

            const width = 1500;
            const height = 900;
            const plot_sizes = {
                top: 500,
                bottom: 150,
                offset: 50
            };

            const margin = {
                top: 100,
                bottom: 100,
                left: 100,
                right: 500
            };

            var time_scale = d3.scaleTime().range([margin.left, width - margin.right]);

            function reduce_fn(items) {
                return {
                    count: items.length,
                    time_first_occurence: d3.min(items, v => v.timestamp),
                    total_size: d3.sum(items, v => v.size),
                    items: items
                };

            }

            const network_data = d3.
            nest().
            key(d => d.user).
            rollup(reduce_fn).
            entries(parsed_data);

            const style_config = {
                time_axis_label: "Date",
                top: {
                    title: "Users",
                    y_axis_label: "Number of revisions",
                    size_label: "Total revision size"
                },

                bottom: {
                    title: "Revisions",
                    y_axis_label: "Size of revision (bytes)",
                    size_label: "Size of revision"
                }
            };



            var getTopTooltipContent = function(d) {
                return `
      <div class="card">
        <h5 class="card-header">${style_config.top.title}</h5>
        <div class="card-body">
          <h5 class="card-title">User: <a href="http://en.wikipedia.org/w/index.php?title=User:${
    d.key
    }">${d.key}</a></h5>
          <p class="card-text">
            <strong>Total Revisions: </strong> ${d.value.count}<br/>
            <strong>Total Revision Size: </strong> ${d.value.total_size}<br/>
            <strong>First Occurence: </strong> ${
    d.value.time_first_occurence
    }<br/>
          </p>
          <p></p>
        </div>
      </div>
      `;
            };

            var getBottomTooltipContent = function(d) {
                return `
    <div class="card">
        <h5 class="card-header">${style_config.bottom.title}</h5>
        <div class="card-body">
          <h5 class="card-title">User: <a href="http://en.wikipedia.org/w/index.php?title=User:${
    d.user
    }">${d.user}</a></h5>
          <p class="card-text">
            <strong>Revision Size: </strong> ${d.size}<br/>
            <strong>Created at: </strong> <a href="http://en.wikipedia.org/w/index.php?title=${title}&oldid=${
    d.id
    }"">${d.timestamp}</a><br/>
            <strong>Comment: </strong> ${d.parsedcomment}<br/>
          </p>
        </div>
      </div>
      `;
            };

            const top_config = {
                y_fn: d => d.count,
                size_fn: d => d.total_size,
                color_fn: d => "DodgerBlue",
                y_scale: d3.scaleLog().range([0, -plot_sizes.top]),
                size_scale: d3.scaleLog().range([3, 10]),
                toolTipContent: getTopTooltipContent
            };

            const bottom_config = {
                y_fn: d => d.size,
                size_fn: d => d.size,
                color_fn: d => "Crimson",
                y_scale: d3.
                scaleLinear().
                range([plot_sizes.bottom + plot_sizes.offset, plot_sizes.offset]),
                size_scale: d3.scaleLog().range([2, 6]),
                toolTipContent: getBottomTooltipContent
            };


            const config = {
                top: top_config,
                bottom: bottom_config
            };


            sctg_layout = sctg().
            topNodeKey(d => d.user).
            topTimeKey(d => d.time_first_occurence).
            bottomTimeKey(d => d.timestamp).
            timeScale(time_scale).
            topReduce(reduce_fn);

            const sctg_layout_values = sctg_layout(network_data, config);

            const mainDiv = d3.select("div.main");

            const svg = mainDiv.
            select("svg").
            attr("width", width).
            attr("height", height).
            attr("viewBox", [
                -margin.left,
                -height + (plot_sizes.top + plot_sizes.bottom) / 2,
                width,
                height
            ]).

            style("background-color", "gainsboro");

            svg.selectAll("*").remove();

            const logDiv = mainDiv.select("div.log-data");

            draw(sctg_layout_values, svg, logDiv, config, style_config);
        }

        (() => {
            createPlot();
            d3.select("#plot-sctg").on("click", () => {
                d3.
                select("div.main svg").
                selectAll("*").
                remove();
                createPlot();
            });
        })();
        //# sourceURL=pen.js
    </script>
</body>

<script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-44393164-1', 'shubhanshu.com');
    ga('send', 'pageview');
</script>
<script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Person",
        "name": "Shubhanshu Mishra",
        "url": "http://shubhanshu.com",
        "logo": "http://shubhanshu.com/assets/images/pic.jpg"
        "sameAs": [
            "https://www.facebook.com/shubhanshu.mishra",
            "https://instagram.com/shubhanshumishra/",
            "https://twitter.com/TheShubhanshu"
            "http://www.linkedin.com/in/shubhanshumishra",
            "https://plus.google.com/+ShubhanshuMishra"
        ]
    }
</script>

</html>